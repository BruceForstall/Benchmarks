trigger: none

schedules:
- cron: "0 7,19 * * *"
  displayName: "Twice a day"
  branches:
    include:
    - main
  always: "true"

variables:
  - group: 'ASP.NET Benchmarks'

# The `resources` specify the location and version of the 1ES PT.
resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release

extends:
  # The pipeline extends the 1ES PT which will inject different SDL and compliance tasks.
  # For non-production pipelines, use "Unofficial" as defined below.
  # For productions pipelines, use "Official".  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: ASP.NET-Performance-Controller-new
      image: MMSWindows2022-Secure
      os: windows

    # opting-out of SBOM generation as we don't produce artifacts
    sdl:
      sbom:
        enabled: false

    stages:
    - stage: Stage
      jobs:
      - job: RegressionBot
        timeoutInMinutes: 30
        
        steps:
        - checkout: dotnet-crank
          path: crank
          displayName: Checkout dotnet/crank
        - powershell: |
              dir .
              
              cd ./crank/src/Microsoft.Crank.RegressionBot
              dotnet build -c release
              
              dotnet run --no-restore --no-build -c release -- `
                  --config https://raw.githubusercontent.com/aspnet/Benchmarks/main/build/regressions.config.yml `
                  --connectionstring BENCHMARKSBOT_ConnectionString `
                  --repository-id $(github.repositoryId) `
                  --app-id $(github.appid) `
                  --install-id $(github.installid) `
                  --username $(github.username) `
                  --app-key BENCHMARKSBOT_GitHubAppKey `
                  --verbose
              
              dotnet run --no-restore --no-build -c release -- `
                  --config https://raw.githubusercontent.com/aspnet/Benchmarks/main/build/regressions.blazor.config.yml `
                  --connectionstring BENCHMARKSBOT_ConnectionString `
                  --repository-id $(github.repositoryId) `
                  --app-id $(github.appid) `
                  --install-id $(github.installid) `
                  --username $(github.username) `
                  --app-key BENCHMARKSBOT_GitHubAppKey `
                  --verbose

          env:
            BENCHMARKSBOT_ConnectionString: $(sql.connectionstring)
            BENCHMARKSBOT_GitHubAppKey: $(github.privatekey)
